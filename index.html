<!DOCTYPE html>
<html>
  <head>
    <title>JS in-browser barcode reader</title>
      <style type="text/css">
        div.video-wrapper {
          position: relative;
          width: 40.000em; height: 30.000em;
        }
        video { position: absolute; top: 0; left: 0;object-fit: fill;width: 100%;height: 100%;}
        #overlay-canvas {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
          z-index: 1003;
          background-color:rgba(0, 0, 0, 0.048);
        }
        div#inner {
          position: absolute;
          margin: 0 auto;
          top: 0; left: 0;
          width: 82.8125%; height: 77.08334%;/* width 82.8125% height 77.08334*/
          border: 3.36607em solid rgba(64,64,64, 0.5);/* 3.36607em */
          /* z-index: 1000; */
        }
        div#redline {
          position: absolute;
          top: 50%;
          width: 99%;
          height:0.3em;
          background-color: rgba(255, 0, 0, 0.3);
          /* z-index: 1001; */
        }
        /* @media screen and (min-width: 320px) and (max-width: 767px) and (orientation: landscape) {
          html {
            transform: rotate(-90deg);
            transform-origin: left top;
            width: 100vh;
            overflow-x: hidden;
            position: absolute;
            top: 100%;
            left: 0;
          }
        } */
      </style>

    </head>
    <body>
      <h1>Barcode scanner</h1>
      <div class="video-wrapper">
        <video autoplay playsinline muted style="pointer-events: none;"></video>
        <div id="inner"></div>
        <div id="redline"></div>
        <canvas id="overlay-canvas" width=640 height=480></canvas>

      </div>
      <ul id="decoded">
      </ul>
      <canvas id="stream-canvas" id="canvas" width=640 height=480
       style="display:block;width: 640px;height: 480px;"></canvas>
      <div class="scan-btn-wrapper">

        <button onclick="localMediaStream ? stop():start()">SCAN</button>
      </div>
      <script type="text/javascript">
        var localMediaStream = null;
        var video = document.querySelector('video');
        var stream_canvas = document.getElementById('stream-canvas')
        var ctx = stream_canvas.getContext('2d')
        var overlay_ctx = document.getElementById('overlay-canvas').getContext('2d')
        var list = document.querySelector('ul#decoded');

        var worker = new Worker('zbar-processor.js');
        worker.onmessage = function(event) {
            if (event.data.length == 0) return;
            var d = event.data[0];
            var entry = document.createElement('li');
            entry.appendChild(document.createTextNode(d[1] + ' (' + d[0] + ')'));
            list.appendChild(entry);
            drawPoly(overlay_ctx, d[2])
            renderData(overlay_ctx, d[1], d[2][0], d[2][1])
            // renderData(overlay_ctx, d[1], d[2][0], d[2][1] - 10)
        };

        function snapshot() {
            if (localMediaStream === null) return;
            ctx.imageSmoothingQuality = "high"
            ctx.filter = "brightness(98%)";
            ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight,
                          0, 0, stream_canvas.width, stream_canvas.height);
            // fix_resolution()

            var data = ctx.getImageData(0, 0,stream_canvas.width, stream_canvas.height);
            worker.postMessage(data);

        }


        function start() {
            navigator.mediaDevices.getUserMedia(
                { video: 
                  {
                    facingMode: "environment"||"user",
                    width:{min:640, ideal:1280,},
                    height:{min:480,ideal:720,},
                    aspectRatio: 2,
                    frameRate: { ideal: 25, max: 30 }
                  }, 
                audio:false,
                }
              ).then((stream)=>{
                           video.srcObject = stream
                           localMediaStream = true
                            
                    }).catch((error)=>alert(error))

            setInterval(snapshot, 1000/3.777778);
        }
        // function fix_resolution(){
        //   video.srcObject.getVideoTracks().forEach((track)=>{
        //     var imageCapture = new ImageCapture(track);
        //     imageCapture.grabFrame().then((imageBitmap) => {
        //       // ctx.imageSmoothingQuality = "high"
        //       ctx.drawImage(imageBitmap,0, 0, video.videoWidth, video.videoHeight,                        
        //       0, 0, stream_canvas.width, stream_canvas.height);
        //     })
        //     .catch(error => {
        //     console.error('grabFrame() error:', error);
        //     alert(error)

        //     });
        //   });
          
       
        // }
        function stop() {
              video.srcObject.getTracks().forEach((track)=>{track.stop()})
              localMediaStream = null
              clearInterval(snapshot)
        }
        function drawPoly(ctx, poly) {
          // var coordinates = trisect(poly)
            // drawPoly expects a flat array of coordinates forming a polygon (e.g. [x1,y1,x2,y2,... etc])
                ctx.beginPath();
                ctx.moveTo(poly[0], poly[1]);
                ctx.strokeStyle = "green";
                ctx.lineWidth = 2.3;
                ctx.shadowColor = '#d53';
                ctx.shadowBlur = 3;
                // var width =Math.abs(poly[poly.length-2] - poly[0])
                // var height =Math.abs(poly[poly.length-1] - poly[1])
                // ctx.strokeRect(poly[0],poly[1], Math.sqrt((height*height) + (width*width)).toFixed(), (height/2).toFixed())  
                // ctx.strokeRect(poly[0],poly[1],
                // coordinates[0]
                // ,coordinates[0]/2)

                for (item = 2; item < poly.length - 1; item += 2) { 
                  ctx.lineTo(poly[item], poly[item + 1]) 
                }
                ctx.closePath();
                ctx.stroke();

            }

            // render the string contained in the barcode as text on the canvas
        function renderData(ctx, data, x, y) {
                ctx.font = "15px Arial";
                ctx.fillStyle = "green";
                // ctx.fillText(data, x, y);
                setTimeout(()=>{
                  ctx.clearRect(0, 0, 640,480)
                },100)
            }
        // function trisect(polygon){
        //   var x = []
        //   var y = []
        //   var l = []
        //   for(var item=2; item<=polygon.length-1;item+=2){
        //     if(polygon[item-2]> 0 && polygon[item-2]!="undefined"){
        //       x.push(polygon[item-2])
        //     }
        //     if(polygon[item-1]> 0 && polygon[item-1]!="undefined"){
        //       y.push(polygon[item-1])
        //     }
        //   }
        //   for(var i=0;i<=x.length-1;i++){
        //     l.push(y[i] >= x[i] ? y[i] - x[i] : x[i] - y[i])  
        //   }
        //   var longest_side = l.sort().reverse()[0]
        //   var x_cord = x.sort().reverse()[0]
        //   var y_cord = y.sort().reverse()[0]
        //   return [longest_side,x_cord,y_cord,y.length]
        // }
        function cropCanvas(sourceCanvas,left,top,width,height) {
              let destCanvas = document.createElement('canvas');
              destCanvas.width = width;
              destCanvas.height = height;
              data = destCanvas.getContext("2d").drawImage(
                  sourceCanvas,
                  left,top,width,height,  // source rect with content to crop
                  0,0,width,height);      // newCanvas, same size as source rect
              return destCanvas;
          }
      </script>
    </body>
</html>
